name: Deploy Frontend to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "Deployment cancelled: confirmation text does not match"
            exit 1
          fi
          echo "Deployment confirmed"

  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: https://${{ secrets.PROD_DOMAIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.production from secrets
        run: |
          cat > .env.production << 'EOF'
          VITE_API_URL=https://${{ secrets.PROD_API_DOMAIN }}
          EOF

      - name: Build frontend (production)
        run: npm run build -- --mode production

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup
        env:
          PROD_HOST: ${{ secrets.PROD_SSH_HOST }}
          PROD_USER: ${{ secrets.PROD_SSH_USER }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
        run: |
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            set -e

            echo "Creating backup..."
            if [ -d "${DEPLOY_PATH}" ]; then
              BACKUP_PATH="${DEPLOY_PATH}_backup_$(date +%Y%m%d_%H%M%S)"
              cp -r ${DEPLOY_PATH} ${BACKUP_PATH}
              echo "Backup created at ${BACKUP_PATH}"
            else
              echo "No existing deployment to backup"
            fi
          ENDSSH

      - name: Prepare deployment directory
        env:
          PROD_HOST: ${{ secrets.PROD_SSH_HOST }}
          PROD_USER: ${{ secrets.PROD_SSH_USER }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
        run: |
          echo "Creating deployment directory on server..."
          ssh ${PROD_USER}@${PROD_HOST} "mkdir -p ${DEPLOY_PATH}"

      - name: Upload built files
        env:
          PROD_HOST: ${{ secrets.PROD_SSH_HOST }}
          PROD_USER: ${{ secrets.PROD_SSH_USER }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
        run: |
          echo "Uploading files to server..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ./dist/ ${PROD_USER}@${PROD_HOST}:${DEPLOY_PATH}/

      - name: Verify deployment
        env:
          PROD_HOST: ${{ secrets.PROD_SSH_HOST }}
          PROD_USER: ${{ secrets.PROD_SSH_USER }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
        run: |
          echo "Verifying deployment..."

          ssh ${PROD_USER}@${PROD_HOST} "ls -la ${DEPLOY_PATH}"

          echo "âœ“ Frontend deployed successfully!"
          echo "Frontend URL: https://${{ secrets.PROD_DOMAIN }}"
          echo "API URL: https://${{ secrets.PROD_API_DOMAIN }}"

      - name: Rollback on failure
        if: failure()
        env:
          PROD_HOST: ${{ secrets.PROD_SSH_HOST }}
          PROD_USER: ${{ secrets.PROD_SSH_USER }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
        run: |
          echo "Deployment failed! Rolling back..."
          ssh ${PROD_USER}@${PROD_HOST} << 'ENDSSH'
            BACKUP_PATH=$(ls -td ${DEPLOY_PATH}_backup_* 2>/dev/null | head -1)
            if [ -n "$BACKUP_PATH" ]; then
              rm -rf ${DEPLOY_PATH}
              cp -r ${BACKUP_PATH} ${DEPLOY_PATH}
              echo "Rolled back to ${BACKUP_PATH}"
            else
              echo "No backup found to rollback"
            fi
          ENDSSH

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "Production frontend deployment successful!"
          else
            echo "Production frontend deployment failed!"
          fi
          # Add notification logic here (Telegram, Slack, email, etc.)
